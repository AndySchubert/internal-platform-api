name: Deploy to Cloud Run

on:
  push:
    branches: 
      - main
      - feature/terraform-gcp

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ vars.REGION }}-docker.pkg.dev

    - name: Build and Push Docker Image
      run: |
        docker build -t ${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_ID }}/internal-platform-api/internal-platform-api:${{ github.sha }} .
        docker push ${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_ID }}/internal-platform-api/internal-platform-api:${{ github.sha }}

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Apply
      working-directory: terraform
      run: terraform apply -auto-approve -var="image_tag=${{ github.sha }}" -var="database_url=${{ secrets.DATABASE_URL }}"

    - name: Output Cloud Run URL
      run: echo "Deployed to $(terraform output -raw cloud_run_url)"