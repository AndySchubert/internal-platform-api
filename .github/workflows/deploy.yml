name: Deploy to Cloud Run

on:
  push:
    branches: 
      - main
      - feature/pytest

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write   # WICHTIG für Workload Identity Federation

    env:
      REGION: us-central1                 # Deine Artifact Registry Region (Iowa)
      REPO_NAME: internal-platform-api    # Name deines Artifact Registry Repos
      IMAGE_NAME: internal-platform-api   # Name des Docker Images
      PROJECT_ID: internal-platform-api   # Dein GCP Project ID (nur für lesbare Namen)

    steps:
    - uses: actions/checkout@v4

    - name: Authenticate to Google Cloud (Workload Identity Federation)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/1062901461072/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
        service_account: 'github-actions-deploy@internal-platform-api.iam.gserviceaccount.com'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

    - name: Build Docker image
      run: >
        docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .

    - name: Push Docker image
      run: >
        docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Apply
      working-directory: terraform
      run: |
        terraform apply -auto-approve \
          -var="image_tag=${{ github.sha }}" \
          -var="database_url=${{ secrets.DATABASE_URL }}"

    - name: Output Cloud Run URL
      working-directory: terraform
      run: echo "Deployed to $(terraform output -raw cloud_run_url)"